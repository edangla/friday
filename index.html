<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Friday</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />
  <!-- App icon for iOS home screen -->
  <link rel="apple-touch-icon" href="icon-180.png?v=2" />
  <!-- Favicons (single PNG for all) -->
  <link rel="icon" href="icon-180.png?v=2" type="image/png" sizes="any" />
  <link rel="shortcut icon" href="icon-180.png?v=2" type="image/png" />
  <meta name="apple-mobile-web-app-title" content="Friday" />
  <style>
    /* ====== THEME (Light by default) ====== */
    :root {
      /* Surfaces & text */
      --bg: #f0f2f5;            /* chat area bg */
      --panel: #ffffff;         /* header & input bar */
      --txt: #111111;           /* main text */
      --muted: #6b7280;         /* secondary text */
      --bubble-bot: #ffffff;    /* bot msg */
      --bubble-border: #e5e7eb; /* subtle border */
      --ok: #16a34a;            /* active green */

      /* Inputs & buttons */
      --input-bg: #ffffff;
      --btn-bg: #eef2f7;        /* neutral button bg */

      /* Primary (blue) – light tone */
      --primary-bg: #a8c8ff;            /* my msg bubble (más intenso) */
      --primary-solid: #a8c8ff;         /* send button mismo tono */
      --primary-solid-hover: #90b9ff;

      --radius: 16px;
      /* iOS safe-area insets */
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --sar: env(safe-area-inset-right);
    }
    body.theme-dark {
      --bg: #0b1220;
      --panel: #0f172a;
      --txt: #e5e7eb;
      --muted: #9ca3af;
      --bubble-bot: #111827;
      --bubble-border: #1f2937;
      --ok: #34d399;

      --input-bg: #0b1324;
      --btn-bg: #0b1324;

      /* Primary (blue) – darker tone */
      --primary-bg: #0c3a8c;         /* my msg bubble (más intenso) */
      --primary-solid: #0c3a8c;      /* send button mismo tono */
      --primary-solid-hover: #0a3278;
    }

    * { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--txt);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app { min-height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }

    @supports (min-height: 100dvh) {
      .app { min-height: 100dvh; }
    }

    /* ====== HEADER ====== */
    header {
      position: sticky; top: 0; z-index: 10;
      display: grid; grid-template-columns: auto 1fr auto; align-items: center;
      gap: 8px; padding: calc(12px + var(--sat)) calc(16px + var(--sar)) 12px calc(16px + var(--sal)); background: var(--panel); border-bottom: 1px solid var(--bubble-border);
    }
    .title { display:flex; flex-direction:column; text-align:center; }
    .title h1 { font-size: 18px; margin: 0; letter-spacing: .2px; font-weight: 700; }
    .title small { font-size: 12px; color: var(--ok); font-weight: 600; }

    .btn { appearance: none; border: 0; padding: 8px 12px; border-radius: 10px; background: var(--btn-bg); color: var(--txt); cursor: pointer; }
    .btn:hover { filter: brightness(0.98); }

    /* ====== CHAT ====== */
    .chat { padding: 12px 12px calc(12px + var(--composerH, 72px)); display: grid; align-content: start; gap: 8px; }
    .msg { display: grid; gap: 4px; max-width: 88%; padding: 8px 10px; border-radius: 16px; border: 1px solid var(--bubble-border); background: var(--bubble-bot); }
    .from-me { justify-self: end; border-bottom-right-radius: 6px; background: var(--primary-bg); border-color: rgba(0,0,0,0.06); color: inherit; }
    .from-bot { justify-self: start; border-bottom-left-radius: 6px; }
    .meta { font-size: 11px; color: var(--muted); justify-self: end; }
    .content { white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; font-size: 14px; }
    .sys { justify-self: center; font-size: 12px; color: var(--muted); padding: 4px 8px; border-radius: 999px; }

    /* ====== COMPOSER ====== */
    .composer { position: sticky; bottom: 0; background: var(--panel); padding: 10px calc(12px + var(--sar)) calc(10px + var(--sab)) calc(12px + var(--sal)); border-top: 1px solid var(--bubble-border); display: grid; gap: 8px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    textarea { width: 100%; resize: none; height: 52px; padding: 12px 14px; border-radius: 20px; background: var(--input-bg); color: var(--txt); border: 1px solid var(--bubble-border); outline: none; line-height: 1.4; font-size: 16px; }
    textarea::placeholder { color: #9aa2ab; }
    .send { width: 52px; min-width: 52px; height: 52px; border-radius: 50%; background: var(--primary-solid); color: #ffffff; font-weight: 700; border: 1px solid var(--bubble-border); display: inline-flex; align-items: center; justify-content: center; padding: 0; }
    .send:hover { background: var(--primary-solid-hover); }
    .send[disabled] { background: var(--btn-bg); color: var(--muted); cursor: not-allowed; opacity: 0.7; }

    /* ====== SETTINGS MODAL ====== */
    .settings { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.25); z-index: 50; }
    .settings.open { display: grid; }
    .card { width: min(520px, 92vw); background: var(--panel); border: 1px solid var(--bubble-border); border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .grid { display: grid; gap: 12px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display:flex; gap:8px; justify-content:flex-end; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], select { $1 font-size: 16px; }

    /* ====== DRAWER (Conversaciones) ====== */
    .drawer { position: fixed; inset: 0 auto 0 0; width: min(92vw, 360px); max-width: 92vw; background: var(--panel); border-right: 1px solid var(--bubble-border); transform: translateX(-100%); transition: transform .2s ease; z-index: 20; display: grid; grid-template-rows: auto 1fr; }
    .drawer.open { transform: translateX(0); }
    .drawer-head { display:flex; align-items:center; justify-content: space-between; gap:8px; padding: 12px; border-bottom: 1px solid var(--bubble-border); }
    .drawer-title { font-weight: 700; margin-left: 4px; }
    .conv-list { overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
    .conv-item { display:block; width:100%; text-align:left; border: 1px solid var(--bubble-border); background: var(--input-bg); color: var(--txt); border-radius: 10px; padding: 10px 12px; cursor: pointer; height: 86px; overflow: hidden; }
    .conv-item.active { background: var(--primary-bg); border-color: rgba(0,0,0,0.06); outline: none; }
    .conv-title { font-size: 14px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .conv-date { font-size: 11px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .conv-sub { font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .conv-card { display:grid; grid-template-rows: auto auto auto; gap:2px; align-content:center; height:100%; min-width:0; }

    @media (min-width: 768px) {
      .chat { padding: 16px; gap: 10px; }
    }
  @media (max-width: 420px) {
      .title h1 { font-size: 16px; }
      .conv-item { height: 80px; }
      .conv-title { font-size: 13px; }
      .conv-sub { font-size: 11.5px; }
      .chat { gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <button class="btn" id="btnDrawer" aria-label="Abrir conversaciones">☰</button>
      <div class="title">
        <h1>Friday</h1>
        <small>Active</small>
      </div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
        <button class="btn" id="btnNewChat" title="Nuevo chat">＋</button>
      </div>
    </header>

    <!-- Drawer lateral -->
    <aside class="drawer" id="drawer">
      <div class="drawer-head">
        <div style="display:flex; align-items:center; gap:8px;">
          <button class="btn" id="btnDrawerInside" aria-label="Cerrar panel">☰</button>
          <span class="drawer-title">Conversaciones</span>
        </div>
        <button class="btn" id="btnSettings" title="Ajustes">⚙️</button>
      </div>
      <div class="conv-list" id="convList"></div>
    </aside>

    <main class="chat" id="chat"></main>

    <div class="composer">
      <div class="row">
        <textarea id="input" placeholder="Escribe un mensaje"></textarea>
        <button class="send" id="btnSend" title="Enviar" disabled>➤</button>
      </div>
    </div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div class="settings" id="settingsModal" aria-hidden="true">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <strong>Ajustes</strong>
        <button class="btn" id="btnClose">✕</button>
      </div>
      <div class="grid">
        <div>
          <label>Webhook URL (n8n → Webhook node)</label>
          <input id="cfgUrl" type="text" placeholder="https://tu-dominio/webhook/inbox" />
        </div>
        <div class="row-2">
          <div>
            <label>Tema</label>
            <select id="cfgTheme">
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="actions">
          <button class="btn" id="btnSave">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    /* =======================
       DOM & UI references
    ======================= */
    const $ = (sel) => document.querySelector(sel);
    const ui = {
      chat: $('#chat'),
      input: $('#input'),
      btnSend: $('#btnSend'),
      btnDrawer: $('#btnDrawer'),
      btnNewChat: $('#btnNewChat'),
      btnDrawerInside: $('#btnDrawerInside'),
      drawer: $('#drawer'),
      convList: $('#convList'),
      settingsModal: $('#settingsModal'),
      btnSettings: $('#btnSettings'),
      btnClose: $('#btnClose'),
      btnSave: $('#btnSave'),
      cfgUrl: $('#cfgUrl'),
      cfgTheme: $('#cfgTheme'),
    };
    const composerEl = document.querySelector('.composer');

    /* =======================
       Utils (pure functions)
    ======================= */
    const escapeHtml = (s) => String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/\"/g,'&quot;')
      .replace(/'/g,'&#39;');

    const formatTimeEU = (d) => {
      try { return new Date(d).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false, hourCycle: 'h23' }); }
      catch { const now = new Date(); const pad=(n)=>String(n).padStart(2,'0'); return `${pad(now.getHours())}:${pad(now.getMinutes())}`; }
    };

    const firstLine = (str) => { if (!str) return ''; const i = str.indexOf('\n'); return (i === -1 ? str : str.slice(0,i)).trim(); };

    const makeConversationId = (d = new Date()) => {
      const pad = (n) => String(n).padStart(2,'0');
      return [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate()), pad(d.getHours()), pad(d.getMinutes()), pad(d.getSeconds())].join('');
    };

    const hasContent = (s) => String(s).trim().length > 0;

    /* =======================
       Layout helpers (mobile)
    ======================= */
    const setComposerPadding = () => {
      const h = composerEl ? composerEl.getBoundingClientRect().height : 72;
      document.documentElement.style.setProperty('--composerH', h + 'px');
    };

    /* =======================
       Persistence
    ======================= */
    const loadSettings = () => {
      const s = JSON.parse(localStorage.getItem('inbox_settings') || '{}');
      return { url: s.url || '', theme: s.theme || 'light', tz: 'Europe/Dublin', timeout: 10000, corsMode: 'cors' };
    };
    const saveSettings = () => {
      const s = { url: (ui.cfgUrl.value || '').trim(), theme: (ui.cfgTheme.value || 'light'), tz: 'Europe/Dublin', timeout: 10000, corsMode: 'cors' };
      localStorage.setItem('inbox_settings', JSON.stringify(s));
      state.settings = s; applyTheme(s.theme);
    };
    const loadConversations = () => {
      const oldHist = JSON.parse(localStorage.getItem('inbox_history') || '[]');
      const saved = JSON.parse(localStorage.getItem('inbox_conversations') || 'null');
      if (!saved) {
        const base = { current: null, order: [], map: {} };
        if (Array.isArray(oldHist) && oldHist.length) { const id = makeConversationId(); base.current = id; base.order.unshift(id); base.map[id] = oldHist; }
        localStorage.setItem('inbox_conversations', JSON.stringify(base));
        return base;
      }
      try {
        if (typeof saved !== 'object' || !saved) throw 0;
        saved.current = saved.current || null;
        saved.order = Array.isArray(saved.order) ? saved.order : [];
        saved.map = (typeof saved.map === 'object' && saved.map) ? saved.map : {};
        return saved;
      } catch {
        const base = { current: null, order: [], map: {} };
        localStorage.setItem('inbox_conversations', JSON.stringify(base));
        return base;
      }
    };
    const saveConversations = () => localStorage.setItem('inbox_conversations', JSON.stringify(state.conv));

    /* =======================
       State
    ======================= */
    const state = { settings: loadSettings(), conv: loadConversations() };

    /* =======================
       Theme & Settings
    ======================= */
    const applyTheme = (theme) => {
      document.body.classList.toggle('theme-dark', theme === 'dark');
      document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#0f172a' : '#ffffff');
    };
    const fillSettingsForm = () => { ui.cfgUrl.value = state.settings.url || ''; ui.cfgTheme.value = state.settings.theme || 'light'; };
    const openSettings = () => { closeDrawer(); fillSettingsForm(); ui.settingsModal.classList.add('open'); ui.settingsModal.setAttribute('aria-hidden','false'); };
    const closeSettings = () => { ui.settingsModal.classList.remove('open'); ui.settingsModal.setAttribute('aria-hidden','true'); };

    /* =======================
       Conversations
    ======================= */
    const ensureConversationExists = () => {
      if (!state.conv.current) createConversation();
      if (!state.conv.map[state.conv.current]) state.conv.map[state.conv.current] = [];
      saveConversations();
    };
    const createConversation = () => {
      const id = makeConversationId();
      state.conv.current = id;
      state.conv.order = [id, ...state.conv.order.filter(x => x !== id)];
      state.conv.map[id] = [];
      saveConversations();
      renderConversationList();
      renderCurrentConversation();
    };
    const setCurrentConversation = (id) => {
      if (!id || !state.conv.map[id]) return;
      state.conv.current = id; saveConversations();
      renderConversationList();
      renderCurrentConversation();
    };
    const getCurrentHistory = () => state.conv.map[state.conv.current] || [];
    const pushHistory = (role, content) => {
      const item = { role, content, when: new Date().toISOString() };
      const arr = state.conv.map[state.conv.current] || (state.conv.map[state.conv.current] = []);
      arr.push(item); saveConversations();
      return item;
    };

    /* =======================
       Rendering
    ======================= */
    const firstUserTitle = (msgs) => {
      if (!msgs || !msgs.length) return 'Nuevo chat';
      const u = msgs.find(m => m && m.role === 'user' && typeof m.content === 'string');
      const pick = (u && u.content) || msgs[0].content || '';
      return firstLine(pick) || 'Nuevo chat';
    };
    const secondLinePreview = (msgs) => { if (!msgs || msgs.length < 2) return ''; const m = msgs[1]; return (m && typeof m.content === 'string') ? firstLine(m.content) : ''; };
    const formatConvTitle = (id) => { if (!id || id.length < 8) return id || 'Chat'; const y=id.slice(0,4), mo=id.slice(4,6), d=id.slice(6,8), hh=id.slice(8,10)||'00', mm=id.slice(10,12)||'00'; return `${d}/${mo}/${y} ${hh}:${mm}`; };

    const renderConversationList = () => {
      ui.convList.innerHTML = '';
      for (const id of state.conv.order) {
        const msgs = state.conv.map[id] || [];
        const btn = document.createElement('button');
        btn.className = 'conv-item' + (id === state.conv.current ? ' active' : '');
        btn.innerHTML = `<div class="conv-card"><div class="conv-title">${escapeHtml(firstUserTitle(msgs))}</div><div class="conv-date">${escapeHtml(formatConvTitle(id))}</div><div class="conv-sub">${escapeHtml(secondLinePreview(msgs))}</div></div>`;
        btn.addEventListener('click', () => { setCurrentConversation(id); closeDrawer(); });
        ui.convList.appendChild(btn);
      }
    };

    const addMsg = (role, content, when) => {
      const el = document.createElement('div');
      if (role === 'system') { el.className = 'sys'; el.textContent = content; ui.chat.appendChild(el); return; }
      el.className = 'msg ' + (role === 'user' ? 'from-me' : 'from-bot');

      const c = document.createElement('div');
      c.className = 'content';
      const label = role === 'user' ? 'Tú' : 'Friday';
      c.innerHTML = '<strong>' + label + '</strong><br/>' + escapeHtml(content).replace(/\n/g,'<br/>' );
      el.appendChild(c);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = formatTimeEU(when || Date.now());
      el.appendChild(meta);

      ui.chat.appendChild(el);
    };

    const renderCurrentConversation = () => { ui.chat.innerHTML = ''; for (const m of getCurrentHistory()) addMsg(m.role, m.content, m.when); };

    /* =======================
       Drawer & Settings
    ======================= */
    const openDrawer = () => ui.drawer.classList.add('open');
    const closeDrawer = () => ui.drawer.classList.remove('open');
    const toggleDrawer = () => ui.drawer.classList.toggle('open');

    /* =======================
       Networking
    ======================= */
    const buildPayload = (text) => ({ conversation_id: state.conv.current, text, source: 'webapp', timezone: state.settings.tz });

    const sendToWebhook = async (payload) => {
      const headers = { 'Accept': 'application/json, text/plain, */*', 'Content-Type': 'application/json' };
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort('timeout'), state.settings.timeout);
      try {
        const resp = await fetch(state.settings.url, { method: 'POST', headers, body: JSON.stringify(payload), signal: ctrl.signal, mode: state.settings.corsMode, credentials: 'omit', referrerPolicy: 'no-referrer' });
        if (!resp || !resp.ok) throw new Error(resp ? ('HTTP ' + resp.status) : 'sin respuesta');
        return resp;
      } finally { clearTimeout(t); }
    };

    const parseReply = async (res) => {
      const ct = (res.headers && res.headers.get && res.headers.get('content-type')) || '';
      if (ct.includes('application/json')) {
        const j = await res.json();
        if (Array.isArray(j)) { const first = j.find(x => x && typeof x.output === 'string'); return (first && first.output) || JSON.stringify(j, null, 2); }
        return j.output || j.reply || j.text || j.message || JSON.stringify(j, null, 2);
      }
      const t = await res.text();
      return t || '✔️ OK';
    };

    /* =======================
       Actions
    ======================= */
    const sendText = async () => {
      const text = (ui.input.value || '').trim();
      if (!text) return;
      if (!state.settings.url) { openSettings(); return; }
      if (location.protocol === 'https:' && state.settings.url.startsWith('http://')) {
        const botItem = pushHistory('assistant', '⚠️ El webhook debe ser HTTPS cuando la app está en HTTPS.'); addMsg('assistant', botItem.content, botItem.when); return;
      }
      ui.input.value = ''; updateSendState();
      const userItem = pushHistory('user', text); addMsg('user', userItem.content, userItem.when);
      try {
        const res = await sendToWebhook(buildPayload(text));
        const reply = await parseReply(res);
        const botItem = pushHistory('assistant', reply); addMsg('assistant', botItem.content, botItem.when);
      } catch (err) {
        const botItem = pushHistory('assistant', '⚠️ Error al enviar: ' + (err.message || err)); addMsg('assistant', botItem.content, botItem.when);
      }
    };

    const updateSendState = () => { ui.btnSend.disabled = !hasContent(ui.input.value); };

    /* =======================
       Events
    ======================= */
    const bindEvents = () => {
      ui.btnSend.addEventListener('click', sendText);
      ui.input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!ui.btnSend.disabled) sendText(); } });
      ui.input.addEventListener('input', updateSendState);

      ui.btnDrawer.addEventListener('click', toggleDrawer);
      ui.btnNewChat.addEventListener('click', createConversation);
      if (ui.btnDrawerInside) ui.btnDrawerInside.addEventListener('click', closeDrawer);

      if (ui.btnSettings) ui.btnSettings.addEventListener('click', openSettings);
      if (ui.btnClose) ui.btnClose.addEventListener('click', closeSettings);
      if (ui.btnSave) ui.btnSave.addEventListener('click', () => { saveSettings(); closeSettings(); });

      // iOS: reduce 300ms delay
      document.addEventListener('touchstart', ()=>{}, {passive:true});
      window.addEventListener('resize', setComposerPadding);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', setComposerPadding);
    };

    /* =======================
       Boot
    ======================= */
    const boot = () => {
      applyTheme(state.settings.theme);
      ensureConversationExists();
      renderConversationList();
      renderCurrentConversation();
      updateSendState();
      bindEvents();
      setComposerPadding();
    };

    boot();

    /* =======================
       Self-tests (console only)
    ======================= */
    (function selfTests(){
      const log = (name, ok) => console.log((ok?'✅':'❌') + ' ' + name);
      try { const converted = 'hola\nmundo'.replace(/\n/g,'<br/>' ); log('Reemplaza \\n por <br/>', converted === 'hola<br/>mundo'); } catch(e){}
      try { const esc = escapeHtml("<b>&\"'></b>"); log('escapeHtml escapa entidades', esc.includes('&lt;b&gt;') && esc.includes('&gt;') && esc.includes('&amp;') && esc.includes('&quot;') && esc.includes('&#39;')); } catch(e){}
      try { const id = makeConversationId(new Date('2025-10-16T12:34:56')); log('conversation_id numerico', id === '20251016123456'); } catch(e){}
      try { const tf = formatTimeEU('2025-10-16T21:05:00'); log('formatTimeEU devuelve HH:mm 24h', /^\d{2}:\d{2}$/.test(tf)); } catch(e){}
      try { const ok = hasContent('123') && !hasContent('   '); log('hasContent: números activan, espacios no', ok); } catch(e){}
      try {
        const arrRes = { headers: { get: ()=>'application/json' }, json: async()=> ([{ output: 'OK' }]) };
        parseReply(arrRes).then(v=>log('parseReply array output', v==='OK'));
        const objRes = { headers: { get: ()=>'application/json' }, json: async()=> ({ reply: 'OK2' }) };
        parseReply(objRes).then(v=>log('parseReply object reply', v==='OK2'));
        const txtRes = { headers: { get: ()=>'text/plain' }, text: async()=>('Plain text') };
        parseReply(txtRes).then(v=>log('parseReply text fallback', v==='Plain text'));
      } catch(e){}
      try {
        const msgs = [ { role:'assistant', content:'Hola' }, { role:'user', content:'Primera línea\nSegunda' }, { role:'assistant', content:'Respuesta' } ];
        log('firstUserTitle toma 1ª línea user', firstUserTitle(msgs)==='Primera línea');
        log('secondLinePreview usa segundo mensaje', secondLinePreview(msgs)==='Primera línea');
      } catch(e){}
      try {
        const p = (text) => ({...buildPayload(text)});
        const sample = p('hola');
        log('payload incluye conversation_id', sample && sample.conversation_id && !('session_id' in sample));
      } catch(e){}
    })();

  })();
  </script>
</body>
</html>
