<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Friday</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="icon-180.png?v=2" />
  <link rel="icon" href="icon-180.png?v=2" type="image/png" sizes="any" />
  <link rel="shortcut icon" href="icon-180.png?v=2" type="image/png" />
  <meta name="apple-mobile-web-app-title" content="Friday" />
  <style>
    :root { --bg:#f0f2f5; --panel:#ffffff; --txt:#111; --muted:#6b7280; --bubble-bot:#fff; --bubble-border:#e5e7eb; --ok:#16a34a; --input-bg:#eef2f7; --btn-bg:#eef2f7; --primary-bg:#0f64ad; --primary-solid:#0f64ad; --primary-solid-hover:#0f64ad; --outline:#111; --radius:16px; --sat:env(safe-area-inset-top); --sab:env(safe-area-inset-bottom); --sal:env(safe-area-inset-left); --sar:env(safe-area-inset-right); }
    body.theme-dark { --bg:#242424; --panel:#242424; --txt:#e5e7eb; --muted:#9ca3af; --bubble-bot:#111827; --bubble-border:#1f2937; --ok:#34d399; --input-bg:#343434; --btn-bg:#343434; --primary-bg:#083c7c; --primary-solid:#083c7c; --primary-solid-hover:#083c7c; --outline:#fff; }
    *{box-sizing:border-box} html{-webkit-text-size-adjust:100%} html,body{height:100%;overflow:hidden}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial;background:var(--bg);color:var(--txt);-webkit-tap-highlight-color:transparent;touch-action:manipulation;overscroll-behavior-y:none}
    .app{height:100vh;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
    @supports(height:100dvh){.app{height:100dvh}}
    @supports(height:100svh){.chat{height:calc(100svh - var(--headerH,56px) - var(--composerH,72px) - var(--kb,0px))}}
    header{position:fixed;left:0;right:0;top:0;z-index:10;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:calc(12px + var(--sat)) calc(16px + var(--sar)) 12px calc(16px + var(--sal));background:var(--panel);border-bottom:1px solid var(--bubble-border)}
    .title{display:flex;align-items:center;gap:8px;text-align:center;justify-self:center}
    .title .title-text{display:flex;flex-direction:column;line-height:1;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;object-fit:cover}
    .title h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:700}
    .title small{font-size:12px;color:var(--ok);font-weight:600}
    .btn{appearance:none;border:0;padding:8px 12px;border-radius:10px;background:var(--btn-bg);color:var(--txt);cursor:pointer}
    .btn:hover{filter:brightness(.98)}
    header .btn,.drawer-head .btn{width:44px;height:44px;min-height:44px;padding:0;border-radius:50%;background:var(--btn-bg);color:var(--txt);display:inline-flex;align-items:center;justify-content:center;font-size:18px;border:1px solid var(--outline)}
    .chat{padding:12px;display:grid;align-content:start;gap:8px;overflow-y:auto;-webkit-overflow-scrolling:touch;height:calc(100dvh - var(--headerH,56px) - var(--composerH,72px) - var(--kb,0px));margin-top:var(--headerH,56px);margin-bottom:var(--composerH,72px);min-height:0}
    .msg{display:grid;gap:4px;max-width:88%;padding:8px 10px;border-radius:16px;border:1px solid var(--bubble-border);background:var(--bubble-bot)}
    .from-me{justify-self:end;border-bottom-right-radius:6px;background:var(--primary-bg);border-color:rgba(0,0,0,.06);color:inherit;min-width:clamp(80px,10%,200px)}
    .from-bot{justify-self:start;border-bottom-left-radius:6px}
    .meta{font-size:11px;color:var(--muted);justify-self:end}
    .from-me .content{color:#fff}
    .msg.from-me .meta{color:#fff}
    .content{white-space:pre-wrap;word-wrap:break-word;line-height:1.5;font-size:16px}
    .sys{justify-self:start;font-size:12px;color:var(--muted);padding:0;border-radius:0;background:transparent;border:none;text-align:left;margin:4px 0}
    .bot-plain{justify-self:start;max-width:88%;padding:0;border:none;background:transparent;margin:4px 0}
    .bot-plain .content{white-space:pre-wrap;line-height:1.5;font-size:16px;color:var(--txt)}
    .msg.typing .content{color:var(--muted)}
    .typing .typing-text{margin-right:6px}
    .typing .dots{display:inline-flex;gap:4px;vertical-align:baseline}
    .typing .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:.35;animation:dotBlink 1.2s infinite}
    .typing .dot:nth-child(2){animation-delay:.2s}
    .typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes dotBlink{0%,80%,100%{opacity:.25;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}
    .typing-line{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:12px;padding:2px 0;justify-self:start}
    .typing-line .typing-text{margin-left:0}
    .composer{position:fixed;left:0;right:0;bottom:var(--kb,0px);background:var(--panel);padding:10px calc(12px + var(--sar)) calc(10px + var(--sab)) calc(12px + var(--sal));border-top:1px solid var(--bubble-border);display:grid;gap:8px}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px}
    textarea{width:100%;resize:none;height:52px;padding:12px 14px;border-radius:999px;background:var(--input-bg);color:var(--txt);border:1px solid var(--outline);outline:none;line-height:1.4;font-size:16px}
    textarea::placeholder{color:#9aa2ab}
    .send{width:52px;min-width:52px;height:52px;border-radius:50%;background:var(--primary-solid);color:#fff;font-weight:700;border:1px solid var(--outline);display:inline-flex;align-items:center;justify-content:center;padding:0}
    .send:hover{background:var(--primary-solid-hover)}
    .send[disabled]{background:var(--btn-bg);color:var(--muted);cursor:not-allowed;opacity:.7}
    input,textarea,select,button{font-size:16px}
    .settings{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);z-index:50}
    .settings.open{display:grid}
    .settings #btnClose{width:44px;height:44px;border-radius:50%;border:1px solid var(--outline);background:var(--btn-bg);color:var(--txt);display:inline-flex;align-items:center;justify-content:center}
    .settings .actions .btn{border:1px solid var(--outline);border-radius:999px;padding:10px 16px;background:var(--btn-bg)}
    .card{width:min(520px,92vw);background:var(--panel);border:1px solid var(--outline);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .grid{display:grid;gap:12px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],select{width:100%;padding:10px 12px;border-radius:999px;border:1px solid var(--outline);background:var(--input-bg);color:var(--txt);font-size:16px}
    .drawer{position:fixed;inset:0 auto 0 0;width:min(77vw,360px);max-width:77vw;background:var(--panel);border-right:1px solid var(--bubble-border);transform:translateX(-100%);transition:transform .2s ease;z-index:50;display:grid;grid-template-rows:auto 1fr}
    .drawer.open{transform:translateX(0)}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;border-bottom:1px solid var(--bubble-border)}
    .drawer-title{font-weight:700;margin-left:4px}
    .conv-list{overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px}
    .conv-item{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;width:100%;text-align:left;border:1px solid var(--bubble-border);background:var(--input-bg);color:var(--txt);border-radius:10px;padding:10px 8px 10px 12px;cursor:pointer;height:86px;overflow:hidden}
    .conv-item.active{background:var(--primary-bg);border-color:rgba(0,0,0,.06);outline:none;color:#fff}
    .conv-item.active .conv-title,.conv-item.active .conv-date,.conv-item.active .conv-sub{color:#fff}
    .conv-title{font-size:14px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .conv-date{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .conv-sub{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .conv-card{display:grid;grid-template-rows:auto auto auto;gap:2px;align-content:center;height:100%;min-width:0}
    .btn-trash{width:36px;height:36px;min-width:36px;border-radius:50%;border:1px solid var(--outline);background:transparent;color:#ef4444;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
    .btn-trash:active{transform:scale(.96)}
    @media (min-width:768px){.chat{padding:16px;gap:10px}}
    @media (max-width:420px){.title h1{font-size:16px}.conv-item{height:80px}.conv-title{font-size:13px}.conv-sub{font-size:11.5px}.chat{gap:6px}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <button class="btn" id="btnDrawer" aria-label="Abrir conversaciones">‚ò∞</button>
      <div class="title">
        <img src="icon-180.png?v=2" alt="Logo" class="logo">
        <div class="title-text">
          <h1>Friday</h1>
          <small>Active</small>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
        <button class="btn" id="btnNewChat" title="Nuevo chat">Ôºã</button>
      </div>
    </header>
    <aside class="drawer" id="drawer">
      <div class="drawer-head">
        <div style="display:flex; align-items:center; gap:8px;">
          <button class="btn" id="btnDrawerInside" aria-label="Cerrar panel">‚ò∞</button>
          <span class="drawer-title">Conversaciones</span>
        </div>
        <button class="btn" id="btnSettings" title="Ajustes">‚öôÔ∏è</button>
      </div>
      <div class="conv-list" id="convList"></div>
    </aside>
    <main class="chat" id="chat"></main>
    <div class="composer">
      <div class="row">
        <textarea id="input" placeholder="Escribe un mensaje" inputmode="text" autocapitalize="sentences" autocomplete="off" autocorrect="on" spellcheck="true"></textarea>
        <button class="send" id="btnSend" title="Enviar" disabled>‚û§</button>
      </div>
    </div>
  </div>
  <div class="settings" id="settingsModal" aria-hidden="true">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <strong>Ajustes</strong>
        <button class="btn" id="btnClose">‚úï</button>
      </div>
      <div class="grid">
        <div>
          <label>Webhook URL (n8n ‚Üí Webhook node)</label>
          <input id="cfgUrl" type="text" placeholder="https://tu-dominio/webhook/inbox" />
        </div>
        <div class="row-2">
          <div>
            <label>Tema</label>
            <select id="cfgTheme">
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="actions">
          <button class="btn" id="btnSave">Guardar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  (() => {
    'use strict';
    const $ = (sel) => document.querySelector(sel);
    const ui = { chat: $('#chat'), input: $('#input'), btnSend: $('#btnSend'), btnDrawer: $('#btnDrawer'), btnNewChat: $('#btnNewChat'), btnDrawerInside: $('#btnDrawerInside'), drawer: $('#drawer'), convList: $('#convList'), settingsModal: $('#settingsModal'), btnSettings: $('#btnSettings'), btnClose: $('#btnClose'), btnSave: $('#btnSave'), cfgUrl: $('#cfgUrl'), cfgTheme: $('#cfgTheme') };
    const headerEl = document.querySelector('header');
    const composerEl = document.querySelector('.composer');
    const escapeHtml = (s) => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    const formatTimeEU = (d) => { try { return new Date(d).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false, hourCycle: 'h23' }); } catch { const n=new Date(); const p=(x)=>String(x).padStart(2,'0'); return p(n.getHours())+':'+p(n.getMinutes()); } };
    const firstLine = (str) => { if (!str) return ''; const i = str.indexOf('\n'); return (i === -1 ? str : str.slice(0,i)).trim(); };
    const makeConversationId = (d=new Date()) => { const p=(n)=>String(n).padStart(2,'0'); return [d.getFullYear(),p(d.getMonth()+1),p(d.getDate()),p(d.getHours()),p(d.getMinutes()),p(d.getSeconds())].join(''); };
    const hasContent = (s) => String(s).trim().length > 0;
    const setLayout = () => { const hh = headerEl ? headerEl.getBoundingClientRect().height : 56; const ch = composerEl ? composerEl.getBoundingClientRect().height : 72; const vv = window.visualViewport; const vvh = (vv ? vv.height : window.innerHeight) || window.innerHeight; let kb = 0; if (vv) { kb = Math.max(0, (window.innerHeight - (vv.height + vv.offsetTop))); } document.documentElement.style.setProperty('--headerH', hh + 'px'); document.documentElement.style.setProperty('--composerH', ch + 'px'); document.documentElement.style.setProperty('--vvh', vvh + 'px'); document.documentElement.style.setProperty('--kb', kb + 'px'); };
    const loadSettings = () => { const s = JSON.parse(localStorage.getItem('inbox_settings') || '{}'); return { url: s.url || '', theme: s.theme || 'light', tz: 'Europe/Dublin', timeout: 120000, corsMode: 'cors' }; };
    const saveSettings = () => { const s = { url: (ui.cfgUrl.value || '').trim(), theme: (ui.cfgTheme.value || 'light'), tz: 'Europe/Dublin', timeout: 120000, corsMode: 'cors' }; localStorage.setItem('inbox_settings', JSON.stringify(s)); state.settings = s; applyTheme(s.theme); };
    const loadConversations = () => { const saved = JSON.parse(localStorage.getItem('inbox_conversations') || 'null'); if (saved && typeof saved === 'object') { saved.current = saved.current || null; saved.order = Array.isArray(saved.order) ? saved.order : []; saved.map = (saved.map && typeof saved.map === 'object') ? saved.map : {}; return saved; } const base = { current: null, order: [], map: {} }; localStorage.setItem('inbox_conversations', JSON.stringify(base)); return base; };
    const saveConversations = () => localStorage.setItem('inbox_conversations', JSON.stringify(state.conv));
    const state = { settings: loadSettings(), conv: loadConversations() };
    const applyTheme = (theme) => { document.body.classList.toggle('theme-dark', theme === 'dark'); document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#242424' : '#ffffff'); };
    const fillSettingsForm = () => { ui.cfgUrl.value = state.settings.url || ''; ui.cfgTheme.value = state.settings.theme || 'light'; };
    const openSettings = () => { closeDrawer(); fillSettingsForm(); ui.settingsModal.classList.add('open'); ui.settingsModal.setAttribute('aria-hidden','false'); };
    const closeSettings = () => { ui.settingsModal.classList.remove('open'); ui.settingsModal.setAttribute('aria-hidden','true'); };
    const ensureConversationExists = () => { if (!state.conv.current) createConversation(); if (!state.conv.map[state.conv.current]) state.conv.map[state.conv.current] = []; saveConversations(); };
    const createConversation = () => { const id = makeConversationId(); state.conv.current = id; state.conv.order = [id, ...state.conv.order.filter(x => x !== id)]; state.conv.map[id] = []; saveConversations(); renderConversationList(); renderCurrentConversation(); };
    const setCurrentConversation = (id) => { if (!id || !state.conv.map[id]) return; state.conv.current = id; saveConversations(); renderConversationList(); renderCurrentConversation(); };
    const getCurrentHistory = () => state.conv.map[state.conv.current] || [];
    const pushHistory = (role, content) => { const item = { role, content, when: new Date().toISOString() }; const arr = state.conv.map[state.conv.current] || (state.conv.map[state.conv.current] = []); arr.push(item); saveConversations(); return item; };
    const deleteConversation = (id) => { if (!state.conv.map[id]) return; delete state.conv.map[id]; state.conv.order = state.conv.order.filter(x => x !== id); if (state.conv.current === id) { state.conv.current = state.conv.order[0] || null; if (!state.conv.current) { createConversation(); return; } } saveConversations(); renderConversationList(); renderCurrentConversation(); };
    const firstUserTitle = (msgs) => { if (!msgs || !msgs.length) return 'Nuevo chat'; const u = msgs.find(m => m && m.role === 'user' && typeof m.content === 'string'); const pick = (u && u.content) || msgs[0].content || ''; return firstLine(pick) || 'Nuevo chat'; };
    const secondLinePreview = (msgs) => { if (!msgs || msgs.length < 2) return ''; const m = msgs[1]; return (m && typeof m.content === 'string') ? firstLine(m.content) : ''; };
    const formatConvTitle = (id) => { if (!id || id.length < 8) return id || 'Chat'; const y=id.slice(0,4), mo=id.slice(4,6), d=id.slice(6,8), hh=id.slice(8,10)||'00', mm=id.slice(10,12)||'00'; return `${d}/${mo}/${y} ${hh}:${mm}`; };
    const renderConversationList = () => { ui.convList.innerHTML = ''; for (const id of state.conv.order) { const msgs = state.conv.map[id] || []; const row = document.createElement('div'); row.className = 'conv-item' + (id === state.conv.current ? ' active' : ''); row.setAttribute('tabindex','0'); row.addEventListener('click', () => { setCurrentConversation(id); closeDrawer(); }); const card = document.createElement('div'); card.className = 'conv-card'; card.innerHTML = `<div class="conv-title">${escapeHtml(firstUserTitle(msgs))}</div><div class="conv-date">${escapeHtml(formatConvTitle(id))}</div><div class="conv-sub">${escapeHtml(secondLinePreview(msgs))}</div>`; const del = document.createElement('button'); del.className = 'btn-trash'; del.title = 'Eliminar conversaci√≥n'; del.innerText = 'üóëÔ∏è'; del.addEventListener('click', (e) => { e.stopPropagation(); deleteConversation(id); }); row.appendChild(card); row.appendChild(del); ui.convList.appendChild(row); } };
    const addMsg = (role, content, when) => {
      const el = document.createElement('div');
      if (role === 'system') {
        el.className = 'sys';
        el.textContent = content;
        ui.chat.appendChild(el);
        requestAnimationFrame(() => { ui.chat.scrollTop = ui.chat.scrollHeight; });
        return;
      }
      if (role === 'assistant') {
        el.className = 'bot-plain';
        const c = document.createElement('div');
        c.className = 'content';
        c.innerHTML = escapeHtml(content).replace(/\n/g,'<br/>');
        el.appendChild(c);
        ui.chat.appendChild(el);
        requestAnimationFrame(() => { ui.chat.scrollTop = ui.chat.scrollHeight; });
        return;
      }
      el.className = 'msg from-me';
      const c = document.createElement('div');
      c.className = 'content';
      c.innerHTML = escapeHtml(content).replace(/\n/g,'<br/>');
      el.appendChild(c);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = formatTimeEU(when || Date.now());
      el.appendChild(meta);
      ui.chat.appendChild(el);
      requestAnimationFrame(() => { ui.chat.scrollTop = ui.chat.scrollHeight; });
    };
    const renderCurrentConversation = () => { ui.chat.innerHTML = ''; for (const m of getCurrentHistory()) addMsg(m.role, m.content, m.when); };

    let typingRef = null;
    const showTyping = () => { if (typingRef) return typingRef; const el = document.createElement('div'); el.className = 'typing-line typing'; el.innerHTML = '<span class="typing-text"></span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>'; ui.chat.appendChild(el); requestAnimationFrame(()=>{ ui.chat.scrollTop = ui.chat.scrollHeight; }); typingRef = el; return el; };
    const hideTyping = () => { if (typingRef && typingRef.parentNode) typingRef.parentNode.removeChild(typingRef); typingRef = null; };
    function updateTyping(txt) { if (typingRef) { const t = typingRef.querySelector('.typing-text'); if (t) t.textContent = txt; } }
    function finalizeTyping(txt) { hideTyping(); const botItem = pushHistory('assistant', txt); addMsg('assistant', botItem.content, botItem.when); }

    const openDrawer = () => ui.drawer.classList.add('open');
    const closeDrawer = () => ui.drawer.classList.remove('open');
    const toggleDrawer = () => ui.drawer.classList.toggle('open');
    const buildPayload = (text) => ({ conversation_id: state.conv.current, text, source: 'webapp', timezone: state.settings.tz });

    const sendToWebhook = async (payload) => {
      const headers = { 'Accept': 'application/x-ndjson, text/plain, application/json, */*', 'Content-Type': 'application/json' };
      try {
        const resp = await fetch(state.settings.url, { method: 'POST', headers, body: JSON.stringify(payload), mode: state.settings.corsMode, credentials: 'omit', referrerPolicy: 'no-referrer' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        let fullText = '';
        if (resp.body) {
          const reader = resp.body.getReader();
          const decoder = new TextDecoder();
          let carry = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            carry += decoder.decode(value, { stream: true });
            let nl;
            while ((nl = carry.indexOf('\n')) !== -1) {
              const line = carry.slice(0, nl).trim();
              carry = carry.slice(nl + 1);
              if (!line) continue;
              try {
                const evt = JSON.parse(line);
                if (evt && evt.type === 'item' && typeof evt.content === 'string') { fullText += evt.content; }
                else if (typeof evt === 'string') { fullText += evt; }
              } catch { fullText += line; }
            }
          }
          const leftover = carry.trim();
          if (leftover) {
            try {
              const evt = JSON.parse(leftover);
              if (evt && evt.type === 'item' && typeof evt.content === 'string') { fullText += evt.content; }
              else if (typeof evt === 'string') { fullText += evt; }
              else { fullText += leftover; }
            } catch { fullText += leftover; }
          }
        } else {
          fullText = await resp.text();
        }
        const botItem = pushHistory('assistant', fullText);
        addMsg('assistant', botItem.content, botItem.when);
      } catch (err) {
        const botItem = pushHistory('assistant', '‚ö†Ô∏è Error al recibir respuesta: ' + (err.message || err));
        addMsg('assistant', botItem.content, botItem.when);
      }
    };

    const sendText = async () => {
      const text = (ui.input.value || '').trim();
      if (!text) return;
      if (!state.settings.url) { openSettings(); return; }
      if (location.protocol === 'https:' && state.settings.url.startsWith('http://')) {
        const botItem = pushHistory('assistant', '‚ö†Ô∏è El webhook debe ser HTTPS cuando la app est√° en HTTPS.');
        addMsg('assistant', botItem.content, botItem.when);
        return;
      }
      ui.input.value = '';
      updateSendState();
      const userItem = pushHistory('user', text);
      addMsg('user', userItem.content, userItem.when);
      await sendToWebhook(buildPayload(text));
    };

    const updateSendState = () => { ui.btnSend.disabled = !hasContent(ui.input.value); };

    const bindEvents = () => {
      ui.btnSend.addEventListener('click', sendText);
      ui.input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!ui.btnSend.disabled) sendText(); } });
      ui.input.addEventListener('input', updateSendState);
      ui.input.addEventListener('focus', () => { setLayout(); requestAnimationFrame(setLayout); setTimeout(setLayout, 50); setTimeout(setLayout, 250); });
      ui.input.addEventListener('blur', () => { setLayout(); requestAnimationFrame(setLayout); setTimeout(setLayout, 50); });
      ui.btnDrawer.addEventListener('click', toggleDrawer);
      ui.btnNewChat.addEventListener('click', createConversation);
      if (ui.btnDrawerInside) ui.btnDrawerInside.addEventListener('click', closeDrawer);
      if (ui.btnSettings) ui.btnSettings.addEventListener('click', openSettings);
      if (ui.btnClose) ui.btnClose.addEventListener('click', closeSettings);
      if (ui.btnSave) ui.btnSave.addEventListener('click', () => { saveSettings(); closeSettings(); setLayout(); });
      document.addEventListener('touchstart', ()=>{}, {passive:true});
      window.addEventListener('resize', setLayout);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', setLayout);
    };

    const boot = () => { applyTheme(state.settings.theme); ensureConversationExists(); renderConversationList(); renderCurrentConversation(); updateSendState(); bindEvents(); setLayout(); };
    boot();
  })();
  </script>
</body>
</html>
